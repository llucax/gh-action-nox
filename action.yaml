name: "Nox"
description: "Runs a nox session"
author: "Frequenz Energy-as-a-Service GmbH"

# Refer to the following link(s) for more information on inputs:
# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#inputs
inputs:
  python-version:
    description: >
      The Python version to use. This is passed to the `actions/setup-python`.
    required: true
  nox-session:
    description: >
      The nox session to run.
    required: true
  nox-dependencies:
    description: >
      The dependencies to install using `pip` to run `nox`. By default
      `".[dev-noxfile]"` is used, but projects not having any extra dependency
      to run nox can just use `"nox"`.
    required: false
    default: ".[dev-noxfile]"
  checkout:
    description: >
      Whether to checkout the repository or not. If set to `false`, the action
      will not checkout the repository. This is useful when the repository is
      already checked out.
    required: false
    default: "true"
  git-username:
    description: >
      The username to use for the Git credentials.
    required: false
  git-password:
    description: >
      The password to use for the Git credentials.
    required: false


# Refer to the following link(s) for more information on the composite run steps:
# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#runs
runs:
  using: "composite"
  steps:
    - name: Print environment (debug)
      shell: bash
      run: env

    - name: Setup Git
      if: inputs.checkout != 'false'
      uses: frequenz-floss/gh-action-setup-git@v1.0.0
      with:
        username: ${{ inputs.git-username }}
        password: ${{ inputs.git-password }}

    - name: Fetch sources
      if: inputs.checkout != 'false'
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Python
      uses: frequenz-floss/gh-action-setup-python-with-deps@v1.0.0
      with:
        python-version: ${{ inputs.python-version }}
        dependencies: ${{ inputs.nox-dependencies }}

    - name: Create nox venv
      shell: bash
      env:
        NOX_SESSION: ${{ inputs.nox-session }}
      run: nox --install-only -e "$NOX_SESSION"

    - name: Print pip freeze for nox venv (debug)
      shell: bash
      env:
        NOX_SESSION: ${{ inputs.nox-session }}
      run: |
        . ".nox/$NOX_SESSION/bin/activate"
        pip freeze
        deactivate

    - name: Run nox
      shell: bash
      env:
        NOX_SESSION: ${{ inputs.nox-session }}
      run: nox -R -e "$NOX_SESSION"
      # Not supported in composite actions yet, see:
      # https://github.com/actions/runner/issues/1979
      # timeout-minutes: 10
